if("object"==typeof exports)var graphlib=require("graphlib"),dagre=require("dagre");graphlib=graphlib||"undefined"!=typeof window&&window.graphlib,dagre=dagre||"undefined"!=typeof window&&window.dagre,joint.layout.DirectedGraph={layout:function(graphOrCells,opt){var graph;graph=graphOrCells instanceof joint.dia.Graph?graphOrCells:(new joint.dia.Graph).resetCells(graphOrCells),graphOrCells=null,opt=_.defaults(opt||{},{resizeClusters:!0,clusterPadding:10});var glGraph=graph.toGraphLib({directed:!0,multigraph:!0,compound:!0,setNodeLabel:function(element){return{width:element.get("size").width,height:element.get("size").height,rank:element.get("rank")}},setEdgeLabel:function(link){return{minLen:link.get("minLen")||1}},setEdgeName:function(link){return link.id}}),glLabel={};return opt.rankDir&&(glLabel.rankdir=opt.rankDir),opt.align&&(glLabel.align=opt.align),opt.nodeSep&&(glLabel.nodesep=opt.nodeSep),opt.edgeSep&&(glLabel.edgesep=opt.edgeSep),opt.rankSep&&(glLabel.ranksep=opt.rankSep),opt.marginX&&(glLabel.marginx=opt.marginX),opt.marginY&&(glLabel.marginy=opt.marginY),glGraph.setGraph(glLabel),dagre.layout(glGraph,{debugTiming:!!opt.debugTiming}),graph.startBatch("layout"),graph.fromGraphLib(glGraph,{importNode:function(v,gl){var element=this.getCell(v),glNode=gl.node(v);opt.setPosition?opt.setPosition(element,glNode):element.set("position",{x:glNode.x-glNode.width/2,y:glNode.y-glNode.height/2})},importEdge:function(edgeObj,gl){var link=this.getCell(edgeObj.name),glEdge=gl.edge(edgeObj),points=glEdge.points||[];opt.setLinkVertices&&(opt.setVertices?opt.setVertices(link,points):link.set("vertices",points.slice(1,points.length-1)))}}),opt.resizeClusters&&_.chain(glGraph.nodes()).filter(function(v){return glGraph.children(v).length>0}).map(graph.getCell,graph).sortBy(function(cluster){return-cluster.getAncestors().length}).invoke("fitEmbeds",{padding:opt.clusterPadding}).value(),graph.stopBatch("layout"),glGraph.graph()},fromGraphLib:function(glGraph,opt){opt=opt||{};var importNode=opt.importNode||_.noop,importEdge=opt.importEdge||_.noop,graph=this instanceof joint.dia.Graph?this:new joint.dia.Graph;return glGraph.nodes().forEach(function(node){importNode.call(graph,node,glGraph,graph,opt)}),glGraph.edges().forEach(function(edge){importEdge.call(graph,edge,glGraph,graph,opt)}),graph},toGraphLib:function(graph,opt){opt=opt||{};var glGraphType=_.pick(opt,"directed","compound","multigraph"),glGraph=new graphlib.Graph(glGraphType),setNodeLabel=opt.setNodeLabel||_.noop,setEdgeLabel=opt.setEdgeLabel||_.noop,setEdgeName=opt.setEdgeName||_.noop;return graph.get("cells").each(function(cell){if(cell.isLink()){var source=cell.get("source"),target=cell.get("target");if(!source.id||!target.id)return;glGraph.setEdge(source.id,target.id,setEdgeLabel(cell),setEdgeName(cell))}else glGraph.setNode(cell.id,setNodeLabel(cell)),glGraph.isCompound()&&cell.has("parent")&&glGraph.setParent(cell.id,cell.get("parent"))}),glGraph}},joint.dia.Graph.prototype.toGraphLib=function(opt){return joint.layout.DirectedGraph.toGraphLib(this,opt)},joint.dia.Graph.prototype.fromGraphLib=function(glGraph,opt){return joint.layout.DirectedGraph.fromGraphLib.call(this,glGraph,opt)};